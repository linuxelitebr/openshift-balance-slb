# OVS Balance-SLB with VM Network Support
# This nmstate configuration includes bridge-mapping for OpenShift Virtualization VMs
#
# Architecture:
#   ens33/ens34 → ovs-bond (balance-slb) → br-phy
#                                            ├── patch-phy-to-ex (VLAN 100 access) → br-ex (Node IP)
#                                            └── (trunk) → VM traffic via localnet
#
# The br-phy bridge serves dual purpose:
#   1. Node traffic: via patch port to br-ex (VLAN 100 access mode)
#   2. VM traffic: direct trunk access for localnet topology

interfaces:
  #---------------------------------------------------------------------------
  # br-ex: OVS Bridge for node networking (OVN integration)
  #---------------------------------------------------------------------------
  - name: br-ex
    type: ovs-bridge
    state: up
    ipv4:
      enabled: false
      dhcp: false
    ipv6:
      enabled: false
      dhcp: false
    bridge:
      allow-extra-patch-ports: true
      port:
      - name: br-ex
      - name: patch-ex-to-phy
    ovs-db:
      external_ids:
        bridge-uplink: "patch-ex-to-phy"

  - name: br-ex
    type: ovs-interface
    state: up
    mtu: 9000
    copy-mac-from: ens33
    ipv4:
      enabled: true
      address:
      - ip: 10.132.254.25        # <-- CHANGE PER NODE
        prefix-length: 24
    ipv6:
      enabled: false
      dhcp: false

  #---------------------------------------------------------------------------
  # br-phy: Physical bridge with balance-slb bond
  # Also used for VM traffic via OVN localnet
  #---------------------------------------------------------------------------
  - name: br-phy
    type: ovs-bridge
    state: up
    mtu: 9000
    ipv4:
      enabled: false
      dhcp: false
    ipv6:
      enabled: false
      dhcp: false
    bridge:
      allow-extra-patch-ports: true
      options:
        stp: false
      port:
      # Patch to br-ex with VLAN 100 access (node traffic)
      - name: patch-phy-to-ex
        vlan:
          mode: access
          tag: 100
      # OVS bond with balance-slb (physical uplinks)
      - name: ovs-bond
        link-aggregation:
          mode: balance-slb
          port:
          - name: ens33
          - name: ens34

  #---------------------------------------------------------------------------
  # Patch ports connecting br-ex and br-phy
  #---------------------------------------------------------------------------
  - name: patch-ex-to-phy
    type: ovs-interface
    state: up
    patch:
      peer: patch-phy-to-ex

  - name: patch-phy-to-ex
    type: ovs-interface
    state: up
    patch:
      peer: patch-ex-to-phy

  #---------------------------------------------------------------------------
  # Physical NICs
  #---------------------------------------------------------------------------
  - name: ens33
    type: ethernet
    state: up
    mtu: 9000
    ipv4:
      enabled: false
    ipv6:
      enabled: false

  - name: ens34
    type: ethernet
    state: up
    mtu: 9000
    ipv4:
      enabled: false
    ipv6:
      enabled: false

#-----------------------------------------------------------------------------
# OVN Configuration - Bridge Mappings for VM traffic
#-----------------------------------------------------------------------------
ovn:
  bridge-mappings:
    # Map 'vmnet' localnet to br-phy for VM traffic
    # VMs using NetworkAttachmentDefinitions with physicalNetworkName: vmnet
    # will have their traffic sent through br-phy (and thus ovs-bond)
    - bridge: br-phy
      localnet: vmnet
      state: present

#-----------------------------------------------------------------------------
# DNS and Routes
#-----------------------------------------------------------------------------
dns-resolver:
  config:
    server:
    - 10.132.254.102
    - 10.132.254.103

routes:
  config:
  - destination: 0.0.0.0/0
    next-hop-address: 10.132.254.10
    next-hop-interface: br-ex
